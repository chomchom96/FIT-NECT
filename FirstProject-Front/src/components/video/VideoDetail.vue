<template>
  <div class="card">
    <li style="margin-top: 40px; margin-bottom: 40px ;" class="comment-row">
      <table class="board-list comment-table">
        <colgroup>
          <col style="width: 100%" />
        </colgroup>
        <thead>
          <tr>
            <th style="display: flex; justify-content: space-between; align-items: center;">
              <span style="text-align: center; padding-left: 5px; display: flex; align-items: flex-start;">
                <!-- <span style="margin-left: 5px;">{{ store.video.videoTitle }}</span> -->
                <span style="margin-left: 5px;">{{ store.video.videoTitle }}</span>
              </span>
              <span style="text-align: right; padding-right: 5px;">
                <span> {{ modifiedVideoPart }} </span>
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="display: flex; justify-content: space-between; align-items: center;">
              <span style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
                <!-- <b style="min-width: 100px;">{{ store.video.videoPart}}</b> -->
                <span style="margin-left: 5px;">Ï°∞ÌöåÏàò {{ store.video.videoViewCnt }}</span>
              </span>
              <span style="text-align: right; padding-right: 5px;">
                <span> {{ store.video.videoCreatedAt }} </span>
              </span>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td style="display: flex; justify-content: space-between; align-items: center;">
              <div style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
                <!-- <b style="min-width: 100px;">{{ store.video.videoPart}}</b> -->
                <!-- <span style="margin-left: 5px;">{{ store.video.videoPart }}</span> -->
              </div>
              <div class="youtube-video">
                <iframe :src="getYouTubeEmbedUrl(store.video.videoUrl)" width="560" height="315" frameborder="0"
                  allowfullscreen></iframe>
              </div>
              <!-- <span style="text-align: right; padding-right: 5px;">
              <span> {{ store.video.videoCreatedAt }} </span>
            </span> -->
            </td>
          </tr>
        </tfoot>
      </table>
    </li>
  </div>


  <!-- <div class="container mt-4 "> -->
  <!-- <div class="card"> -->
  <!-- <div class="card-header">
          <h2 class="card-title board-list">{{ store.video.videoTitle }}</h2>
        </div> -->
  <!-- <div class="card-body"> -->
  <!-- <h2 class="card-title board-list">{{ store.video.videoTitle }}</h2> -->
  <!-- <div class="details board-list"> -->
  <!-- <p class="card-text"><strong>ÌååÌä∏:</strong> {{ store.video.videoPart }}</p> -->
  <!-- <div class="youtube-video">
              <iframe :src="getYouTubeEmbedUrl(store.video.videoUrl)" width="560" height="315" frameborder="0"
                allowfullscreen></iframe>
            </div>
            <p class="card-text"><strong>Îì±Î°ùÏùº:</strong> {{ store.video.videoCreatedAt }}</p>
            <p class="card-text"><strong>Ï°∞ÌöåÏàò:</strong> {{ store.video.videoViewCnt }}</p>
          </div> -->

  <!-- </div> -->

  <!--Í∏∞Ï°¥ Î¶¨Î∑∞ Í∏∞Îä•-->
  <!-- <div>
          <h3> Comments </h3>
          <br />
          <div class="details" v-for="review in reviews" :key="review.reviewId">
            <div>
              <div class="card-body">
                <h3 class="card-title">{{ review.title }}</h3>
                <p class="card-text">{{ review.userId }}</p>
                <p class="card-text">{{ review.content }}</p>
  
                <button v-if="userStore.idValue === 'admin' || userStore.idValue === review.userId"
                  @click="deleteReview(review.reviewId)">ÏÇ≠Ï†ú</button>
              </div>
              <br />
            </div>
          </div>
  
        </div> -->

  <!--ÏÉàÎ°úÏö¥ ÎîîÏûêÏù∏ Î¶¨Î∑∞ Í∏∞Îä•-->
  <div>
    <br>
    <h3> review </h3>
    <br>
    <div>
      <li v-for="review in reviews" :key="review.reviewId" style="margin-bottom: 75px;" class="comment-row">

        <span v-if="!review.isEditing" @mouseover="setHovered(review.reviewId, true)"
          @mouseleave="setHovered(review.reviewId, false)">
          <table class="board-list comment-table">
            <colgroup>
              <col style="width: 100%" />
            </colgroup>
            <thead>
              <tr>
                <th style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="text-align: center; padding-left: 5px; display: flex; align-items: flex-start;">
                    <!-- <b style="min-width: 100px;">{{ review.userId }}</b> -->
                    <span style="margin-left: 5px;">{{ review.title }}</span>
                    <!-- <span v-if="isHovered(index)" style="cursor: pointer; margin-left: 10px; " @click="removeComment">&times;</span> -->
                    <div v-show="isHovered(review.reviewId)">
                      <span v-if="!review.isEditing">
                        <span title="ÏàòÏ†ï">
                          <button @click="() => updateReviewState(review.reviewId, review.userId)"
                            style="margin-left: 10px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 16px;">üñç</button>
                        </span>
                      </span>
                      <span title="ÏÇ≠Ï†ú">
                        <button @click="() => deleteReview(review.reviewId, review.userId)"
                          style="margin-left: 10px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 16px;">‚úñ</button>
                      </span>

                    </div>
                  </span>
                  <span style="text-align: right; padding-right: 5px;">
                    <span> ‚≠êü§¢‚≠ê‚≠ê‚≠ê </span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
                    <b style="min-width: 100px;">{{ review.userId }}</b>
                    <span style="margin-left: 5px;">{{ review.content }}</span>
                    <!-- <span v-if="isHovered(index)" style="cursor: pointer; margin-left: 10px; " @click="removeComment">&times;</span> -->
                    <!-- <div v-show="isHovered(index)">
                          <span v-if="!review.isEditing">
                          <span title="ÏàòÏ†ï">
                            <button @click="() => updateReviewState(review.reviewId, review.userId)"
                              style="margin-left: 10px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 16px;">üñç</button>
                          </span>
                        </span>
                          <span title="ÏÇ≠Ï†ú">
                            <button @click="() => deleteReview(review.reviewId, review.userId)"
                              style="margin-left: 10px; border: none; background: none; cursor: pointer; font-weight: bold; font-size: 16px;">‚úñ</button>
                          </span>
                          
                        </div> -->
                  </span>
                  <span style="text-align: right; padding-right: 5px;">
                    <span> {{ review.createdAt }} </span>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

        </span>
        <div v-else>
          <table class="board-list">
            <colgroup>
              <col style="width: 100%" />
            </colgroup>
            <thead>
              <tr>
                <!-- <th>{{ review.title }}</th> -->
                <td style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
                    <!-- <b style="min-width: 100px;"> {{ userStore.idValue }}</b> -->
                    <span style="margin-left: 5px;">
                      <input type="text" v-model="modifyReview.title" id="title" placeholder="Î¶¨Î∑∞Ï†úÎ™©ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî" required
                        style="width: calc(250px); height: 24px;">
                    </span>
                  </span>
                  <!-- <span style="text-align: right; padding-right: 5px;">
                    <button class="commentbtn" @click="updateReview(review.reviewId, review.userId)">ÏàòÏ†ï</button>
                  </span> -->
                </td>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
                    <b style="min-width: 100px;"> {{ userStore.idValue }}</b>
                    <span style="margin-left: 5px;">
                      <input type="text" v-model="modifyReview.content" id="content" placeholder="Î¶¨Î∑∞ÎÇ¥Ïö©Î•º ÏàòÏ†ïÌïòÏÑ∏Ïöî" required
                        style="width: calc(250px); height: 24px;">
                    </span>
                  </span>
                  <span style="text-align: right; padding-right: 5px;">
                    <button class="commentbtn" @click="updateReview(review.reviewId, review.userId)">ÏàòÏ†ï</button>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </li>
    </div>
  </div>

  <!--Î¶¨Î∑∞ÏûëÏÑ±Ïπ∏-->
  <div v-if="userStore.getUser">
    <table class="board-list">


      <colgroup>
        <col style="width: 100%" />
      </colgroup>
      <thead>
        <tr>
          <th style="display: flex; justify-content: space-between; align-items: center;">
            <!-- <span style="text-align: center; padding-left: 5px; display: flex; align-items: flex-start;">
                        <span style="margin-left: 5px;">{{ review.title }}</span>
                      </span> -->
            <span style="margin-left: 5px;">
              <input type="text" v-model="review.title" id="title" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required
                style="width: calc(250px); height: 24px;">
            </span>

            <span style="text-align: right; padding-right: 5px;">
              <span> ü§¢ü§¢ü§¢ü§¢ü§¢ </span>
            </span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="display: flex; justify-content: space-between; align-items: center;">
            <span style="text-align: left; padding-left: 5px; display: flex; align-items: flex-start;">
              <b style="min-width: 100px;"> {{ userStore.idValue }}</b>
              <span style="margin-left: 5px;">
                <input type="text" v-model="review.content" id="content" placeholder="Î¶¨Î∑∞Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî" required
                  style="width: calc(250px); height: 24px;">
              </span>
            </span>
            <span style="text-align: right; padding-right: 5px;">
              <button class="commentbtn" @click="createReview()">Îì±Î°ù</button>
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div v-else>
    <br>
    Î°úÍ∑∏Ïù∏Ìïú ÌöåÏõêÎßå ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.
  </div>




  <!--ÎπÑÎîîÏò§ Í≤åÏãúÍ∏Ä ÏàòÏ†ï/ÏÇ≠Ï†ú Í∏∞Îä•-->
  <div>
    <button v-if="userStore.idValue == 'admin'" @click="updateVideo">ÏàòÏ†ï</button>
    <button v-if="userStore.idValue == 'admin'" @click="deleteVideo">ÏÇ≠Ï†ú</button>
  </div>
  <!-- </div> -->
  <!-- </div> -->
</template>
  
<script setup>
import { ref, onMounted, computed } from 'vue'
import { useVideoStore } from '@/stores/video'
import { useUserStore } from '../../stores/user'
import { useRoute, useRouter } from 'vue-router'
import axios from 'axios'


const route = useRoute();
const router = useRouter();
const store = useVideoStore();
const userStore = useUserStore();
const reviews = ref([])


const review = ref({
  reviewId: "",
  videoId: "",
  userId: "",
  createdAt: "",
  title: "",
  content: "",
  isEditing: false,
  cnt: 1,
})

const modifyReview = ref({
  reviewId: "",
  videoId: "",
  userId: "",
  createdAt: "",
  title: "",
  content: "",
  isEditing: false,
});

const getYouTubeEmbedUrl = (url) => {
  if (!url) {
    return '';
  }

  const videoIdMatch = url.match(/[?&]v=([^&]+)/);
  if (!videoIdMatch) {
    return '';
  }

  const videoId = videoIdMatch[1];
  return `https://www.youtube.com/embed/${videoId}`;
};

onMounted(async () => {
  await store.getVideo(route.params.id)
  await increaseViewCnt();
  await fetchReviews(route.params.id)


})



async function increaseViewCnt() {
  try {
    console.log(route.params.id)
    await axios.post(`http://localhost:8080/api/view/${route.params.id}`);
    console.log('Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä!');
  } catch (error) {
    console.log(error)
  }
};

async function fetchReviews() {
  try {
    const response = await axios.get(`http://localhost:8080/api/review?videoId=${store.video.videoId}`)
    reviews.value = response.data
  } catch (error) {
    console.log(error)
  }
}

const updateReviewState = (reviewId, userId) => {
  console.log(userId);
  console.log(userStore.idValue)
  if (userId === userStore.idValue || userStore.idValue === "admin") {
    // ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ Î¶¨Î∑∞Ïùò ÏàòÏ†ï ÏÉÅÌÉúÎ•º trueÎ°ú Î≥ÄÍ≤Ω
    const index = reviews.value.findIndex((item) => item.reviewId === reviewId && item.userId === userId);
    if (index !== -1) {
      reviews.value[index].isEditing = true;
      modifyReview.value.review = reviews.value[index].review; // Í∏∞Ï°¥ Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏàòÏ†ï Î¶¨Î∑∞ ÏûÖÎ†• ÌïÑÎìúÏóê ÏÑ§Ï†ï
    }
  } else {
    alert("Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§");
  }
};



//Î¶¨Î∑∞ ÏûëÏÑ± Í∏∞Îä•

const createReview = async function () {
  if (review.value.title.trim == "" || review.value.content.trim == "") {
    alert("ÎÇ¥Ïö©ÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî")
    return;
  }

  review.value.userId = userStore.idValue;
  review.value.videoId = store.video.videoId;

  await createReviewPromise(review.value);

  const reviewAPI_URL = `http://localhost:8080/api/review`;

  axios({
    url: `${reviewAPI_URL}?videoId=${store.video.videoId}`,
    method: "GET",
  })
    .then((reviewRes) => {

      reviews.value = [];

      reviewRes.data.forEach((reviewData) => {
        reviews.value.push({
          reviewId: reviewData.reviewId,
          videoId: reviewData.videoId,
          userId: reviewData.userId,
          title: reviewData.title,
          content: reviewData.content,
          createdAt: reviewData.createdAt,
        });
      });

    })
    .catch((reviewErr) => {
      console.error(reviewErr);
    });

  review.value.title = "";
  review.value.content = "";

}


const createReviewPromise = (review) => {
  return new Promise((resolve, reject) => {
    const API_URL = `http://localhost:8080/api/review`;

    axios({
      url: API_URL,
      method: "POST",
      data: {
        videoId: review.videoId,
        reviewId: review.reviewId,
        userId: review.userId,
        createdAt: review.createdAt,
        title: review.title,
        content: review.content,
      },
    })
      .then(() => {
        alert("Î¶¨Î∑∞ Îì±Î°ù ÏôÑÎ£å");
        resolve();
        //  router.push("/video/${videoId}");
      })
      .catch((err) => {
        console.log(err);
        reject();
      });
  })
};

// Î¶¨Î∑∞ ÏàòÏ†ï Í∏∞Îä•

//ÏΩîÎ©òÌä∏ ÏàòÏ†ï
const updateReview = async function (reviewId, userId) {
  // console.log("ÌîÑÎ°†Ìä∏ÏóêÏÑúÌôïÏù∏")
  // console.log(userId)
  modifyReview.value.videoId = store.video.videoId;
  modifyReview.value.userId = store.idValue;
  // console.log(board.value.boardId); 

  await modifyReviewPromise(reviewId, modifyReview.value.content, modifyReview.value.title);
  const reviewAPI_URL = `http://localhost:8080/api/review`;

  axios({
    url: `${reviewAPI_URL}?videoId=${store.video.videoId}`,
    method: "GET",
  })
    .then((reviewRes) => {

      reviews.value = [];

      reviewRes.data.forEach((reviewData) => {
        reviews.value.push({
          reviewId: reviewData.reviewId,
          videoId: reviewData.videoId,
          userId: reviewData.userId,
          title: reviewData.title,
          content: reviewData.content,
          createdAt: reviewData.createdAt,
        });
      });

    })
    .catch((reviewErr) => {
      console.error(reviewErr);
    });

  modifyReview.value.content = "";
}

const modifyReviewPromise = (reviewId, newContent, newTitle) => {
  console.log(reviewId)
  return new Promise((resolve, reject) => {
    // console.log(comment.boardId)
    console.log(newContent)
    const API_URL = `http://localhost:8080/api/review/${reviewId}`;
    axios({
      url: API_URL,
      method: "PUT",
      data: {
        reviewId: reviewId,
        videoId: review.videoId,
        userId: review.userId,
        content: newContent,
        title: newTitle,
        createdAt: review.createdAt,
      },
    })
      .then(() => {
        resolve();
        // router.push("/board");
      })
      .catch((err) => {
        console.log(err);
        alert("ÏóêÎü¨Î∞úÏÉù")
        reject();
      });
  })

};


const deleteReview = async function (reviewId, userId) {

  if (userId === userStore.idValue || userStore.idValue === "admin") {

    try {
      await axios.delete(`http://localhost:8080/api/review/${reviewId}`);
      console.log('Î¶¨Î∑∞ ÏÇ≠Ï†ú ÏôÑÎ£å!')
      await fetchReviews();
    } catch (error) {
      console.log(error);
    }
  } else {
    alert("Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§");
  }
};

const updateVideo = async function (videoId) {

}


const deleteVideo = async function () {
  try {
    await axios.delete(`http://localhost:8080/api/video/${store.video.videoId}`);
    console.log('ÏÇ≠Ï†ú ÏôÑÎ£å!')
    router.push("/video");
  } catch (error) {
    console.log(error);
  }
};

const hoverStates = ref([]);

const setHovered = (reviewId, value) => {
  hoverStates.value[reviewId] = value;
  console.log(reviewId)
  console.log(value);

};

const isHovered = (reviewId) => {
  return hoverStates.value[reviewId];
  console.log(hoverStates.value)
};


const modifiedVideoPart = computed(() => {
  // console.log(store.video);
  if (store.video.videoPart) {
    const modifiedValue = store.video.videoPart.split('(')[0].trim();
    return modifiedValue;
  }
  return "Í∞íÏù¥ ÏóÜÏäµÎãàÎã§."
});

</script>
  
<style scoped>
.youtube-video {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%;
}

.youtube-video iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.container {
  text-align: center;
  flex-direction: column;
  align-items: center;
}

.board-list {
  width: 85%;
  border-collapse: collapse;
  margin-top: 5px;
}


.board-list tr:hover td {
  background-color: rgb(221, 219, 219);
}


.board-list th,
.board-list td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
  border-left: 1px solid white;
  border-right: 1px solid white;
}

.board-list th {
  background-color: #f2f2f2;
}

.board-link {
  color: darkslategrey;
  text-decoration: none;
}

.board-link:hover {
  text-decoration: underline;
}

.left {
  text-align: left;
  padding-left: 10px;
}

.title {
  text-align: center;
}

.board-list td.left {
  text-align: left;
  padding-left: 20px;
  /* Ï∂îÍ∞ÄÌïú Ïó¨Î∞± */
}

.row {
  text-align: center;
}

/* .search-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  } */



.btn {
  padding: 10px;
  background-color: #333;
  /* Î¨¥Ï±ÑÏÉâ Î∞∞Í≤Ω */
  color: #fff;
  /* Ìù∞ÏÉâ ÌÖçÏä§Ìä∏ */
  border: none;
  cursor: pointer;
  margin-right: 10px;
}

.btn:hover {
  background-color: #555;
  /* Ìò∏Î≤Ñ Ïãú Ïñ¥Îë°Í≤å Î≥ÄÌïòÎäî Î∞∞Í≤Ω */
}

.content-cell {
  padding: 20px;
  /* ÎÇ¥Ïö© Ï£ºÎ≥ÄÏùò Ïó¨Î∞±ÏùÑ Ï°∞Ï†à */
  text-align: left;
  /* ÌÖçÏä§Ìä∏Î•º ÏôºÏ™Ω Ï†ïÎ†¨Î°ú Î≥ÄÍ≤Ω */
  white-space: pre-wrap;
  /* Ï§Ñ Î∞îÍøàÍ≥º Í∞ôÏùÄ Í≥µÎ∞± Ïú†ÏßÄ */
  font-size: 16px;
  /* ÏõêÌïòÎäî Ìè∞Ìä∏ ÌÅ¨Í∏∞Î°ú Ï°∞Ï†à */
  width: 80%;
  /* Í∏∞Î≥∏ÏúºÎ°ú ÎÇ¥Ïö©ÏùÑ 80% ÎÑìÏù¥Î°ú ÏÑ§Ï†ï */
  margin: 0;
  /* Ï¢åÏö∞ Ïó¨Î∞± Ï†úÍ±∞ */
  overflow-y: auto;
  height: 200px;
}

input[type="text"],
textarea {
  width: calc(100% - 20px);
  /* ÌÖåÎëêÎ¶¨ Ìè¨Ìï®ÌïòÏó¨ ÍΩâ Ï∞®ÎèÑÎ°ù ÎÑàÎπÑ Ï°∞Ï†à */
  height: calc(100% - 20px);
  border: 1px solid white;
  /* ÌÖåÎëêÎ¶¨Î•º Ìù∞ÏÉâÏúºÎ°ú ÏÑ§Ï†ï */
}
</style>
  